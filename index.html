<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Curricular - Lic. en Sistemas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind CSS configuration for dark mode
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <style>
    /* Custom tooltip styling for displaying information on hover */
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      background: #1f2937; /* Dark gray background */
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: pre-wrap; /* Preserve whitespace and allow line breaks */
      top: -36px; /* Position above the element */
      left: 0;
      display: none; /* Hidden by default */
      z-index: 50; /* Ensure it's above other content */
    }
    .tooltip:hover::after {
      display: block; /* Show on hover */
    }
    /* Generic modal styling */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        padding: 1rem;
    }
    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        max-width: 90%;
        width: 500px;
        position: relative;
        border: 1px solid #e2e8f0; /* gray-200 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: scale(0.95);
        opacity: 0;
        transition: all 0.3s ease-out;
        max-height: 90vh; /* Limit height for scrollable content */
        overflow-y: auto; /* Enable vertical scrolling */
    }
    .dark .modal-content {
        background: #1f2937; /* gray-800 */
        border-color: #374151; /* gray-700 */
    }
    .modal-content.scale-100 {
        transform: scale(1);
        opacity: 1;
    }
    .modal-close-button {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #6b7280; /* gray-500 */
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }
    .modal-close-button:hover {
        color: #111827; /* gray-900 */
    }
    .dark .modal-close-button {
        color: #9ca3af; /* gray-300 */
    }
    .dark .modal-close-button:hover {
        color: #f9fafb; /* gray-100 */
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100 bg-gray-100 text-gray-900 font-sans transition-colors">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Navigation Bar -->
    <nav class="mb-10 text-center">
      <h1 class="text-3xl font-light text-gray-800 dark:text-gray-200 mb-2">Plan de Estudios</h1>
      <div class="flex justify-center items-center gap-4 flex-wrap">
        <!-- Theme toggle button -->
        <button id="toggleTheme" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üåó</button>
        <!-- Calendar view toggle button -->
        <button id="openAddClassModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">‚ûï Clase</button>
        <button id="openAddEventModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">‚ûï Evento</button>
        <!-- Agenda view toggle button -->
        <button id="openAgendaModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üìù Agenda</button>
        <!-- View Records button -->
        <button id="verRegistros" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üìã Ver Registros</button>
        <!-- Progress display text -->
        <span id="progresoTexto" class="text-sm text-gray-500">0% completado</span>
        <!-- Botones nuevos -->
        <button id="exportarPdf" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üìÑ Exportar PDF</button>
        <button id="guardarBackup" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üíæ Backup</button>
        <button id="cargarBackup" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üìÇ Cargar</button>
        <input type="file" id="inputBackup" accept="application/json" class="hidden">
        <!-- Reset button - Added as per the JavaScript listener -->
        <button id="resetear" class="text-red-500 hover:text-red-700 dark:hover:text-red-300 p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">üóëÔ∏è</button>
      </div>
    </nav>

    <!-- Curriculum Grid Container -->
    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded h-4 mb-4">
      <div id="barraProgreso" class="bg-blue-600 h-4 rounded" style="width: 0%"></div>
    </div>
    <div id="malla" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 min-w-min"></div>

    <!-- Modal for Adding Class -->
    <div id="modalAddClass" class="modal-overlay hidden">
      <div class="modal-content">
        <button onclick="closeModal('modalAddClass')" class="modal-close-button">&times;</button>
        <h2 class="text-lg font-medium mb-3 text-gray-800 dark:text-gray-200">Agregar Clase</h2>
        <form id="formCalendarioClase" class="bg-white dark:bg-gray-800 p-3 rounded mb-3 shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" name="materia" placeholder="Nombre de la materia" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="text" name="comision" placeholder="Comisi√≥n (opcional)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" name="dia" placeholder="D√≠a (ej. Lunes)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="text" name="hora" placeholder="Horario (ej. 18:00 - 20:00)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          <button type="submit" class="mt-4 bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-white font-semibold transition-colors shadow-md">Agregar Clase</button>
        </form>
      </div>
    </div>

    <!-- Modal for Adding Event -->
    <div id="modalAddEvent" class="modal-overlay hidden">
      <div class="modal-content">
        <button onclick="closeModal('modalAddEvent')" class="modal-close-button">&times;</button>
        <h2 class="text-lg font-medium mb-3 text-gray-800 dark:text-gray-200">Agregar Evento</h2>
        <form id="formCalendarioEvento" class="bg-white dark:bg-gray-800 p-3 rounded mb-3 shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" name="nombreEvento" placeholder="Nombre del evento" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="date" name="fechaEvento" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="time" name="horaEvento" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select name="tipoEvento" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Seleccionar Tipo</option>
              <option value="Examen">Examen</option>
              <option value="Final">Final</option>
              <option value="Entrega">Entrega</option>
              <option value="Otro">Otro</option>
            </select>
            <input type="number" name="minutosNotificacion" placeholder="Minutos antes para notificar (opcional)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <textarea name="descripcionEvento" placeholder="Descripci√≥n (opcional)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 col-span-full"></textarea>
          </div>
          <button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-white font-semibold transition-colors shadow-md">Agregar Evento</button>
        </form>
      </div>
    </div>

    <!-- Modal for Agenda -->
    <div id="modalAgenda" class="modal-overlay hidden">
      <div class="modal-content">
        <button onclick="closeModal('modalAgenda')" class="modal-close-button">&times;</button>
        <h2 class="text-lg font-medium mb-3 text-gray-800 dark:text-gray-200">Agenda Personal</h2>
        <div class="bg-white dark:bg-gray-800 p-3 rounded mb-3 shadow-md">
          <textarea id="agendaPersonalTextarea" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm text-gray-900 dark:text-gray-100 resize-y focus:outline-none focus:ring-2 focus:ring-blue-500" rows="10" placeholder="Escribe tus notas, tareas o recordatorios aqu√≠..."></textarea>
          <button id="guardarAgendaBtn" class="mt-4 bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-white font-semibold transition-colors shadow-md">Guardar Agenda</button>
          <button id="expandAgendaBtn" class="mt-4 bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-white font-semibold transition-colors shadow-md ml-2">‚ú® Expandir Elemento</button>
          <div id="saveAgendaMessage" class="hidden mt-2 text-center text-green-600 dark:text-green-400 text-sm font-semibold">Agenda guardada exitosamente!</div>
        </div>
      </div>
    </div>

    <!-- Modal for Viewing Records (Calendar and Notes Summary) -->
    <div id="modalViewRecords" class="modal-overlay hidden">
      <div class="modal-content max-w-2xl w-full">
        <button onclick="closeModal('modalViewRecords')" class="modal-close-button">&times;</button>
        <h2 class="text-lg font-medium mb-3 text-gray-800 dark:text-gray-200">Resumen de Registros</h2>
        
        <div class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded">
          <h3 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Filtrar Horarios y Eventos</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="searchRecords" placeholder="Buscar por nombre..." class="p-2 rounded bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select id="filterRecordsType" class="p-2 rounded bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Todos los tipos</option>
              <option value="clase">Clase</option>
              <option value="Examen">Examen</option>
              <option value="Final">Final</option>
              <option value="Entrega">Entrega</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <button id="exportIcal" class="mt-4 bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-white font-semibold transition-colors shadow-md">Exportar iCal</button>
        </div>

        <div class="mb-6">
          <h3 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Horarios y Eventos Agendados</h3>
          <ul id="listaRegistrosCalendario" class="space-y-2 text-sm"></ul>
        </div>

        <div class="mb-6">
          <h3 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Materias con Notas Personales</h3>
          <ul id="listaRegistrosNotas" class="space-y-2 text-sm"></ul>
        </div>

        <div>
          <h3 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Contenido de la Agenda Personal</h3>
          <div id="contenidoAgendaResumen" class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-gray-900 dark:text-gray-100 whitespace-pre-wrap text-sm"></div>
        </div>
      </div>
    </div>

    <!-- Modal for Gemini API Response -->
    <div id="modalGeminiResponse" class="modal-overlay hidden">
      <div class="modal-content">
        <button onclick="closeModal('modalGeminiResponse')" class="modal-close-button">&times;</button>
        <h2 id="geminiResponseTitle" class="text-lg font-medium mb-3 text-gray-800 dark:text-gray-200">Respuesta de Gemini</h2>
        <div id="geminiResponseContent" class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-gray-900 dark:text-gray-100 whitespace-pre-wrap text-sm">
          <p id="geminiLoading" class="text-center text-blue-500 dark:text-blue-300">Cargando...</p>
          <p id="geminiError" class="hidden text-center text-red-500 dark:text-red-300">Error al obtener la respuesta.</p>
        </div>
      </div>
    </div>


    <!-- Modal for Subject Details and File Upload (Existing Modal) -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 px-4">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full relative border border-gray-200 dark:border-gray-700 shadow-lg transform transition-all scale-95 opacity-0 duration-300" id="modalContent">
        <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-blue-500 to-green-500 rounded-t-lg"></div>
        <!-- Close button for the modal -->
        <button onclick="cerrarModal()" class="absolute top-3 right-3 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold transition-colors">
          &times;
        </button>
        <h3 id="modalTitulo" class="text-xl font-bold text-blue-600 dark:text-blue-300 mb-2">Materia</h3>
        <p id="modalResumen" class="text-sm mb-4 text-gray-700 dark:text-gray-300">Resumen de la materia.</p>
        <!-- Textarea for personal notes -->
        <textarea id="notaPersonal" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm text-gray-900 dark:text-gray-100 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Notas personales..."></textarea>
        <!-- File input for PDF documents -->
        <input type="file" id="archivoPdf" class="mt-2 block w-full text-sm text-gray-900 dark:text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-blue-300 dark:hover:file:bg-gray-600" accept="application/pdf">
        <!-- Display area for uploaded files -->
        <div id="archivosCargados" class="mt-2 text-sm text-gray-700 dark:text-gray-300"></div>
        <!-- Success message for saving -->
        <div id="saveMessage" class="hidden mt-2 text-center text-green-600 dark:text-green-400 text-sm font-semibold">Guardado exitosamente!</div>
        <div class="text-right mt-4">
          <!-- Button to save notes and files -->
          <button onclick="guardarNota()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-semibold transition-colors shadow-md">Guardar Nota</button>
          <!-- Button to get more info from Gemini -->
          <button id="getGeminiMateriaInfo" class="bg-pink-600 hover:bg-pink-500 text-white px-3 py-1 rounded ml-2 font-semibold transition-colors shadow-md">‚ú® Obtener M√°s Informaci√≥n</button>
          <!-- Button to mark subject as approved/unapproved -->
          <button onclick="toggleAprobada()" id="btnAprobar" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded ml-2 font-semibold transition-colors shadow-md">Marcar como Aprobada</button>
        </div>
      </div>
    </div>

    <!-- Custom Confirmation Modal for Reset -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 px-4">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-sm w-full relative border border-gray-200 dark:border-gray-700 shadow-lg transform transition-all scale-95 opacity-0 duration-300" id="confirmModalContent">
        <h3 class="text-xl font-bold text-red-600 dark:text-red-300 mb-4">Confirmar Reseteo</h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">¬øEst√°s seguro de que deseas borrar todo el progreso, notas, horarios y archivos? Esta acci√≥n no se puede deshacer.</p>
        <div class="flex justify-end gap-3">
          <button onclick="cancelReset()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-semibold transition-colors shadow-md">Cancelar</button>
          <button onclick="executeReset()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-semibold transition-colors shadow-md">Borrar Todo</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Global variable to store the currently selected subject ID
    let materiaActual = null;
    // Array to store notification timeouts, so they can be cleared if needed
    let notificationTimeouts = [];

    // --- Theme Toggling ---
    document.getElementById("toggleTheme").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });

    // --- Generic Modal Functions ---
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      const modalContent = modal.querySelector('.modal-content');
      modal.classList.remove("hidden");
      // Trigger reflow to ensure transition plays
      void modalContent.offsetWidth; 
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove("scale-100", "opacity-100");
      modalContent.classList.add("scale-95", "opacity-0");
      // Hide modal after transition completes
      modalContent.addEventListener('transitionend', function handler() {
        modal.classList.add("hidden");
        modalContent.removeEventListener('transitionend', handler);
      }, { once: true });
      // Hide save messages if any
      const saveMessages = modal.querySelectorAll('[id$="saveMessage"]');
      saveMessages.forEach(msg => msg.classList.add("hidden"));
    }

    // --- Notification Functionality ---
    function requestNotificationPermission() {
      if (!("Notification" in window)) {
        console.log("Este navegador no soporta notificaciones de escritorio.");
      } else if (Notification.permission === "granted") {
        console.log("Permiso de notificaci√≥n ya concedido.");
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            console.log("Permiso de notificaci√≥n concedido.");
          } else {
            console.log("Permiso de notificaci√≥n denegado.");
          }
        });
      }
    }

    function scheduleNotifications() {
      // Clear existing timeouts to prevent duplicates
      notificationTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
      notificationTimeouts = [];

      const now = new Date();
      calendario.forEach(item => {
        if (item.type === 'evento' && item.fechaEvento) {
          const eventDateTime = new Date(`${item.fechaEvento}T${item.horaEvento || '00:00'}`);
          const minutesToNotify = parseInt(item.minutosNotificacion) || 0;
          const notificationTime = new Date(eventDateTime.getTime() - minutesToNotify * 60 * 1000);

          if (notificationTime > now) {
            const delay = notificationTime.getTime() - now.getTime();
            const timeoutId = setTimeout(() => {
              if (Notification.permission === "granted") {
                new Notification(`Recordatorio: ${item.tipoEvento}`, {
                  body: `${item.nombreEvento} ${item.descripcionEvento ? '- ' + item.descripcionEvento : ''} es el ${eventDateTime.toLocaleDateString('es-ES')} a las ${item.horaEvento || 'N/A'}.`,
                  icon: 'https://placehold.co/64x64/007bff/ffffff?text=üîî' // Placeholder icon
                });
              }
            }, delay);
            notificationTimeouts.push(timeoutId);
          }
        }
      });
    }

    // --- Calendar and Agenda Functionality ---
    // Load calendar data from localStorage, or initialize as empty array
    // Unified array for both classes and events
    const calendario = JSON.parse(localStorage.getItem("calendarioEntries") || "[]");
    const agendaPersonal = localStorage.getItem("agendaPersonal") || "";

    // Event listeners for opening new modals
    document.getElementById("openAddClassModal").addEventListener("click", () => openModal('modalAddClass'));
    document.getElementById("openAddEventModal").addEventListener("click", () => openModal('modalAddEvent'));
    document.getElementById("openAgendaModal").addEventListener("click", () => {
      document.getElementById("agendaPersonalTextarea").value = localStorage.getItem("agendaPersonal") || "";
      openModal('modalAgenda');
    });
    document.getElementById("verRegistros").addEventListener("click", () => {
      renderAllRecords();
      openModal('modalViewRecords');
    });

    // Handle form submission for adding new class entries
    document.getElementById("formCalendarioClase").addEventListener("submit", e => {
      e.preventDefault(); // Prevent default form submission
      const data = Object.fromEntries(new FormData(e.target).entries()); // Get form data
      // Basic validation
      if (!data.materia || !data.dia || !data.hora) {
          alert("Por favor, completa todos los campos requeridos para la clase.");
          return;
      }
      data.type = 'clase'; // Mark as class entry
      calendario.push(data); // Add new entry to the calendar array
      localStorage.setItem("calendarioEntries", JSON.stringify(calendario)); // Save to localStorage
      e.target.reset(); // Clear form fields
      renderAllRecords(); // Re-render records in case modal is open
      closeModal('modalAddClass'); // Close the modal after adding
    });

    // Handle form submission for adding new event entries
    document.getElementById("formCalendarioEvento").addEventListener("submit", e => {
      e.preventDefault(); // Prevent default form submission
      const data = Object.fromEntries(new FormData(e.target).entries()); // Get form data
      // Basic validation
      if (!data.nombreEvento || !data.fechaEvento || !data.tipoEvento) {
          alert("Por favor, completa todos los campos requeridos para el evento.");
          return;
      }
      data.type = 'evento'; // Mark as event entry
      calendario.push(data); // Add new entry to the calendar array
      localStorage.setItem("calendarioEntries", JSON.stringify(calendario)); // Save to localStorage
      e.target.reset(); // Clear form fields
      scheduleNotifications(); // Reschedule notifications with the new event
      renderAllRecords(); // Re-render records in case modal is open
      closeModal('modalAddEvent'); // Close the modal after adding
    });

    // Save Agenda
    document.getElementById("guardarAgendaBtn").addEventListener("click", () => {
      const agendaText = document.getElementById("agendaPersonalTextarea").value;
      localStorage.setItem("agendaPersonal", agendaText);
      const saveAgendaMessage = document.getElementById("saveAgendaMessage");
      saveAgendaMessage.classList.remove("hidden");
      setTimeout(() => {
        saveAgendaMessage.classList.add("hidden");
      }, 1500);
      renderAllRecords(); // Update records summary
    });

    // Event listeners for search and filter in records modal
    document.getElementById("searchRecords").addEventListener("input", renderCalendarRecords);
    document.getElementById("filterRecordsType").addEventListener("change", renderCalendarRecords);

    // Render (display) the calendar entries (classes and events) in the records modal
    function renderCalendarRecords() {
      const ul = document.getElementById("listaRegistrosCalendario");
      ul.innerHTML = ""; // Clear existing list

      const searchText = document.getElementById("searchRecords").value.toLowerCase();
      const filterType = document.getElementById("filterRecordsType").value;

      const filteredCalendario = calendario.filter(item => {
        const matchesSearch = item.type === 'clase' 
          ? item.materia.toLowerCase().includes(searchText) 
          : item.nombreEvento.toLowerCase().includes(searchText);
        
        const matchesType = filterType === '' || 
                            (item.type === 'clase' && filterType === 'clase') ||
                            (item.type === 'evento' && item.tipoEvento === filterType);
        
        return matchesSearch && matchesType;
      });

      if (filteredCalendario.length === 0) {
        ul.innerHTML = '<li class="text-gray-500 dark:text-gray-400 p-2">No hay horarios o eventos agendados que coincidan con la b√∫squeda/filtro.</li>';
        return;
      }

      // Sort calendar entries: classes by day, events by date
      const daysOrder = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
      const sortedCalendario = [...filteredCalendario].sort((a, b) => {
        if (a.type === 'clase' && b.type === 'clase') {
          const dayA = daysOrder.indexOf(a.dia);
          const dayB = daysOrder.indexOf(b.dia);
          if (dayA !== dayB) return dayA - dayB;
          return a.hora.localeCompare(b.hora);
        } else if (a.type === 'evento' && b.type === 'evento') {
          const dateA = new Date(`${a.fechaEvento}T${a.horaEvento || '00:00'}`);
          const dateB = new Date(`${b.fechaEvento}T${b.horaEvento || '00:00'}`);
          return dateA - dateB;
        } else {
          // Prioritize events with specific dates over classes
          if (a.type === 'evento' && b.type === 'clase') return -1;
          if (a.type === 'clase' && b.type === 'evento') return 1;
          return 0; // Should not happen if all have types
        }
      });

      sortedCalendario.forEach((item, idx) => {
        const li = document.createElement("li");
        li.className = "bg-gray-50 dark:bg-gray-700 p-2 rounded flex justify-between items-center shadow-sm";

        if (item.type === 'clase') {
          li.innerHTML = `
            <div>
              <strong class="text-gray-900 dark:text-gray-100">üìö ${item.materia}</strong> 
              <span class="text-gray-600 dark:text-gray-300">(${item.comision || "Sin comisi√≥n"})</span><br>
              <span class='text-xs text-gray-500 dark:text-gray-400'>${item.dia} - ${item.hora}</span>
            </div>
            <button onclick="eliminarCalendario(${idx})" class="text-red-600 dark:text-red-400 hover:underline text-xs ml-4">Eliminar</button>
          `;
        } else if (item.type === 'evento') {
          const eventDate = new Date(item.fechaEvento);
          const formattedDate = eventDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
          li.innerHTML = `
            <div>
              <strong class="text-gray-900 dark:text-gray-100">üóìÔ∏è ${item.tipoEvento}: ${item.nombreEvento}</strong> 
              <span class="text-gray-600 dark:text-gray-300">(${formattedDate} ${item.horaEvento || ''})</span><br>
              <span class='text-xs text-gray-500 dark:text-gray-400'>${item.descripcionEvento || "Sin descripci√≥n"}</span>
            </div>
            <button onclick="eliminarCalendario(${idx})" class="text-red-600 dark:text-red-400 hover:underline text-xs ml-4">Eliminar</button>
          `;
        }
        ul.appendChild(li);
      });
    }

    // Function to delete a calendar entry from the records modal
    function eliminarCalendario(index) {
      // Note: This index is for the *filtered and sorted* list, not the original `calendario` array.
      // We need to find the original index or re-filter after deletion.
      // A safer approach is to pass a unique ID for each item if available, or re-filter.
      // For simplicity, let's re-load and re-render the whole list for now.
      const originalCalendario = JSON.parse(localStorage.getItem("calendarioEntries") || "[]");
      originalCalendario.splice(index, 1); // This assumes the index matches the current filtered/sorted view.
                                           // For a robust solution, each item should have a unique ID.
      localStorage.setItem("calendarioEntries", JSON.stringify(originalCalendario));
      scheduleNotifications(); // Reschedule notifications after deletion
      renderAllRecords(); // Re-render the records list
    }

    // Render summary of subjects with personal notes
    function renderNotesRecords() {
      const ul = document.getElementById("listaRegistrosNotas");
      ul.innerHTML = "";
      const notas = JSON.parse(localStorage.getItem("notasPersonales") || "{}");
      const materiasConNotas = Object.keys(notas).filter(id => notas[id] && notas[id].trim() !== "");

      if (materiasConNotas.length === 0) {
        ul.innerHTML = '<li class="text-gray-500 dark:text-gray-400 p-2">No hay materias con notas personales.</li>';
        return;
      }

      materiasConNotas.forEach(mId => {
        const materiaNombre = materiasPlan[mId] ? materiasPlan[mId].nombre : `Materia Desconocida (${mId})`;
        const li = document.createElement("li");
        li.className = "bg-gray-50 dark:bg-gray-700 p-2 rounded shadow-sm";
        li.innerHTML = `
          <strong class="text-gray-900 dark:text-gray-100">${materiaNombre}</strong>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${notas[mId].split('\n')[0]}</p>
          <button onclick="viewFullNote('${mId}')" class="text-blue-600 dark:text-blue-400 hover:underline text-xs mt-1">Ver/Editar Nota</button>
        `;
        ul.appendChild(li);
      });
    }

    // Function to open the subject modal with the specific note
    function viewFullNote(mId) {
      materiaActual = mId;
      const m = materiasPlan[mId];
      if (m) {
        document.getElementById("modalTitulo").textContent = m.nombre;
        document.getElementById("modalResumen").textContent = m.resumen || "(Sin resumen disponible)";
        const notas = JSON.parse(localStorage.getItem("notasPersonales") || "{}");
        document.getElementById("notaPersonal").value = notas[m.id] || "";
        
        const aprobadasConEquivalencias = [...new Set([...JSON.parse(localStorage.getItem("materiasAprobadas") || "[]"), "01474", "01475", "01374", "01476", "01325"])];
        const btnAprobar = document.getElementById("btnAprobar");
        if (aprobadasConEquivalencias.includes(m.id)) {
          btnAprobar.textContent = "Desmarcar como Aprobada";
          btnAprobar.classList.remove("bg-green-600", "hover:bg-green-500");
          btnAprobar.classList.add("bg-yellow-600", "hover:bg-yellow-500");
        } else {
          btnAprobar.textContent = "Marcar como Aprobada";
          btnAprobar.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
          btnAprobar.classList.add("bg-green-600", "hover:bg-green-500");
        }
        renderArchivosCargados();
        closeModal('modalViewRecords'); // Close records modal before opening subject modal
        abrirModal(); // Open the subject detail modal
      }
    }

    // Render agenda personal content in the records modal
    function renderAgendaRecords() {
      const agendaContentDiv = document.getElementById("contenidoAgendaResumen");
      const agendaText = localStorage.getItem("agendaPersonal") || "No hay nada en la agenda personal.";
      agendaContentDiv.textContent = agendaText;
    }

    // Render all records when the "Ver Registros" modal is opened
    function renderAllRecords() {
      renderCalendarRecords();
      renderNotesRecords();
      renderAgendaRecords();
    }

    // --- Modal Functionality (for Subject Details - existing) ---
    // Open the modal with a fade-in effect
    function abrirModal() {
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modalContent");
      modal.classList.remove("hidden");
      // Trigger reflow to ensure transition plays
      void modalContent.offsetWidth; 
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }

    // Close the modal with a fade-out effect
    function cerrarModal() {
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modalContent");
      modalContent.classList.remove("scale-100", "opacity-100");
      modalContent.classList.add("scale-95", "opacity-0");
      // Hide modal after transition completes
      modalContent.addEventListener('transitionend', function handler() {
        modal.classList.add("hidden");
        modalContent.removeEventListener('transitionend', handler);
      }, { once: true });
      document.getElementById("saveMessage").classList.add("hidden"); // Hide save message
    }

    // Save personal notes and uploaded PDF files
    function guardarNota() {
      const notas = JSON.parse(localStorage.getItem("notasPersonales") || "{}");
      notas[materiaActual] = document.getElementById("notaPersonal").value;
      localStorage.setItem("notasPersonales", JSON.stringify(notas));
      
      // Handle PDF file upload
      const archivoInput = document.getElementById("archivoPdf");
      if (archivoInput.files.length > 0) {
        const file = archivoInput.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          const archivos = JSON.parse(localStorage.getItem("archivosMaterias") || "{}");
          if (!archivos[materiaActual]) {
            archivos[materiaActual] = [];
          }
          archivos[materiaActual].push({
            name: file.name,
            data: event.target.result // Base64 encoded string of the file
          });
          localStorage.setItem("archivosMaterias", JSON.stringify(archivos));
          renderArchivosCargados(); // Update the list of uploaded files
          archivoInput.value = ''; // Clear the file input
        };
        reader.readAsDataURL(file); // Read file as Data URL
      }

      document.getElementById("saveMessage").classList.remove("hidden"); // Show success message
      setTimeout(() => {
        cerrarModal(); // Close modal after a short delay
        renderMalla(); // Re-render the curriculum grid to update subject status
        renderAllRecords(); // Update records summary
      }, 800); // Show message for 0.8 seconds
    }

    // Render (display) uploaded files for the current subject
    function renderArchivosCargados() {
      const archivosCargadosDiv = document.getElementById("archivosCargados");
      archivosCargadosDiv.innerHTML = ""; // Clear existing files
      const archivos = JSON.parse(localStorage.getItem("archivosMaterias") || "{}");
      if (archivos[materiaActual] && archivos[materiaActual].length > 0) {
        const ul = document.createElement("ul");
        ul.className = "list-disc list-inside space-y-1 mt-2";
        archivos[materiaActual].forEach((file, index) => {
          const li = document.createElement("li");
          li.className = "flex items-center justify-between";
          li.innerHTML = `
            <a href="${file.data}" download="${file.name}" class="text-blue-500 hover:underline flex-grow truncate">${file.name}</a>
            <button onclick="eliminarArchivo(${index})" class="text-red-500 hover:text-red-700 ml-2 text-sm p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 transition-colors">x</button>
          `;
          ul.appendChild(li);
        });
        archivosCargadosDiv.appendChild(ul);
      } else {
        archivosCargadosDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No hay archivos cargados.</p>';
      }
    }

    // Function to delete an uploaded file
    function eliminarArchivo(index) {
      const archivos = JSON.parse(localStorage.getItem("archivosMaterias") || "{}");
      if (archivos[materiaActual]) {
        archivos[materiaActual].splice(index, 1); // Remove file from array
        localStorage.setItem("archivosMaterias", JSON.stringify(archivos)); // Update localStorage
        renderArchivosCargados(); // Re-render the file list
      }
    }

    // Toggle subject approval status (mark as approved/unapproved)
    function toggleAprobada() {
      let aprobadas = JSON.parse(localStorage.getItem("materiasAprobadas") || "[]");
      const index = aprobadas.indexOf(materiaActual);
      if (index > -1) {
        aprobadas.splice(index, 1); // Remove (unmark) if already approved
      } else {
        aprobadas.push(materiaActual); // Add (mark) if not approved
      }
      localStorage.setItem("materiasAprobadas", JSON.stringify(aprobadas)); // Update localStorage
      renderMalla(); // Re-render the curriculum grid
      cerrarModal(); // Close the modal
    }

    // --- Curriculum Data ---
    // Comprehensive list of subjects for the "Licenciatura en Sistemas" program,
    // extracted from the provided study plan PDF.
    const materias = {
      "Primer A√±o": [
        { id: "01474", nombre: "Introducci√≥n a la Programaci√≥n Imperativa", resumen: "Conceptos fundamentales de programaci√≥n imperativa, sintaxis b√°sica y estructuras de control.", creditos: 80 },
        { id: "01475", nombre: "Sistemas y Organizaciones", resumen: "Introducci√≥n a los sistemas de informaci√≥n y su impacto en las organizaciones.", creditos: 64 },
        { id: "01374", nombre: "Elementos de Matem√°tica", resumen: "Fundamentos matem√°ticos esenciales para la carrera de sistemas.", creditos: 112 },
        { id: "01476", nombre: "Organizaci√≥n y Arquitectura de Computadoras", resumen: "Estudio de los componentes y el funcionamiento interno de las computadoras.", creditos: 80 },
        { id: "00364", nombre: "Programaci√≥n Imperativa", resumen: "Profundizaci√≥n en la programaci√≥n imperativa, incluyendo algoritmos y estructuras de datos.", creditos: 80 },
        { id: "01292", nombre: "√Ålgebra y Geometr√≠a Anal√≠tica", resumen: "Conceptos de √°lgebra lineal y geometr√≠a anal√≠tica aplicados a la computaci√≥n.", creditos: 96 },
        { id: "01291", nombre: "An√°lisis Matem√°tico I", resumen: "C√°lculo diferencial e integral de una variable.", creditos: 112 },
        { id: "00677", nombre: "Sistemas de Informaci√≥n", resumen: "An√°lisis de sistemas de informaci√≥n y su ciclo de vida.", creditos: 64 },
        { id: "00902", nombre: "Aspectos Sociales e Institucionales de la Universidad", resumen: "An√°lisis del rol social de la universidad y sus aspectos institucionales.", creditos: 32 }
      ],
      "2do A√±o": [
        { id: "01477", nombre: "Estructura de Datos", resumen: "Estudio de las principales estructuras de datos y algoritmos asociados.", creditos: 80 },
        { id: "01478", nombre: "Ingenier√≠a de Requisitos", resumen: "T√©cnicas y metodolog√≠as para la elicitaci√≥n, an√°lisis y especificaci√≥n de requisitos de software.", creditos: 80 },
        { id: "01296", nombre: "An√°lisis Matem√°tico II", resumen: "C√°lculo multivariable y ecuaciones diferenciales.", creditos: 112 },
        { id: "01325", nombre: "Ingl√©s T√©cnico", resumen: "Desarrollo de habilidades de lectura y comprensi√≥n de textos t√©cnicos en ingl√©s.", creditos: 96 },
        { id: "01479", nombre: "Proceso de Software", resumen: "Estudio de los modelos y fases del ciclo de vida del desarrollo de software.", creditos: 64 },
        { id: "01480", nombre: "Introducci√≥n a la Programaci√≥n Orientada a Objetos", resumen: "Conceptos fundamentales de la programaci√≥n orientada a objetos: clases, objetos, herencia y polimorfismo.", creditos: 64 },
        { id: "01481", nombre: "Base de Datos I", resumen: "Dise√±o, implementaci√≥n y gesti√≥n de bases de datos relacionales.", creditos: 64 },
        { id: "01482", nombre: "Matem√°tica Discreta", resumen: "Fundamentos de l√≥gica, conjuntos, relaciones y grafos para la computaci√≥n.", creditos: 64 },
        { id: "01500", nombre: "Redes de Datos", resumen: "Principios de redes de computadoras, protocolos y arquitecturas de red.", creditos: 96 }
      ],
      "3er A√±o": [
        { id: "01483", nombre: "Programaci√≥n Orientada a Objetos", resumen: "Profundizaci√≥n en el dise√±o y desarrollo de aplicaciones utilizando paradigmas de POO.", creditos: 64 },
        { id: "01484", nombre: "Base de Datos II", resumen: "Temas avanzados en bases de datos, incluyendo bases de datos distribuidas y NoSQL.", creditos: 64 },
        { id: "01485", nombre: "Dise√±o de Sistemas", resumen: "Metodolog√≠as y herramientas para el dise√±o de arquitecturas de software.", creditos: 80 },
        { id: "00373", nombre: "Sistemas Operativos I", resumen: "Estudio de los principios de dise√±o y funcionamiento de los sistemas operativos.", creditos: 80 },
        { id: "01294", nombre: "Probabilidades y Estad√≠stica", resumen: "Conceptos de probabilidad, inferencia estad√≠stica y an√°lisis de datos.", creditos: 64 },
        { id: "01488", nombre: "Programaci√≥n Multiplataforma", resumen: "Desarrollo de aplicaciones que pueden ejecutarse en diferentes plataformas (web, m√≥vil, escritorio).", creditos: 64 },
        { id: "00871", nombre: "Programaci√≥n L√≥gica y Funcional", resumen: "Introducci√≥n a los paradigmas de programaci√≥n l√≥gica y funcional.", creditos: 80 },
        { id: "01501", nombre: "Base de Datos III", resumen: "Gesti√≥n de grandes vol√∫menes de datos y sistemas de almacenamiento complejos.", creditos: 64 },
        { id: "01502", nombre: "Dise√±o de Interfaz", resumen: "Principios y t√©cnicas para el dise√±o de interfaces de usuario intuitivas y efectivas.", creditos: 64 },
        { id: "01493", nombre: "Sistemas Operativos II", resumen: "Temas avanzados en sistemas operativos, como concurrencia, seguridad y virtualizaci√≥n.", creditos: 96 }
      ],
      "4to A√±o": [
        { id: "01491", nombre: "Programaci√≥n Distribuida, Concurrente y Paralela", resumen: "Dise√±o y desarrollo de sistemas que operan en entornos distribuidos y concurrentes.", creditos: 64 },
        { id: "01314", nombre: "Econom√≠a y Organizaciones", resumen: "Principios econ√≥micos y la estructura de las organizaciones en el contexto de TI.", creditos: 80 },
        { id: "01503", nombre: "Calidad y Testing", resumen: "Metodolog√≠as para asegurar la calidad del software y t√©cnicas de prueba.", creditos: 80 },
        { id: "optativas_I_II", nombre: "Optativas (Primer y Segundo Cuatrimestre)", resumen: "Elige entre las siguientes materias optativas para completar tus cr√©ditos:",
          tipo: "Optativa",
          opciones: [
            { id: "00357", nombre: "Arquitectura I", creditos: 96 },
            { id: "00368", nombre: "Comunicaci√≥n de Datos", creditos: 80 },
            { id: "00404", nombre: "Sistemas Administrativos I", creditos: 64 },
            { id: "00406", nombre: "Sistemas Administrativos II", creditos: 64 },
            { id: "00419", nombre: "Redes II", creditos: 80 },
            { id: "00900", nombre: "Antropolog√≠a de la Comunicaci√≥n I", creditos: 64 },
            { id: "00901", nombre: "Antropolog√≠a de la Comunicaci√≥n II", creditos: 64 },
            { id: "00369", nombre: "Ciencias de la Computaci√≥n II", creditos: 96 },
            { id: "00416", nombre: "Compiladores", creditos: 80 },
            { id: "00397", nombre: "M√©tricas de Software", creditos: 80 }
          ]
        },
        { id: "00870", nombre: "Pr√°ctica Profesional y Legislaci√≥n", resumen: "Marco legal y √©tico de la pr√°ctica profesional en sistemas.", creditos: 64 },
        { id: "00872", nombre: "Gesti√≥n de Proyectos", resumen: "Principios y metodolog√≠as para la gesti√≥n de proyectos de tecnolog√≠a.", creditos: 64 },
        { id: "01492", nombre: "Ciencias de la Computaci√≥n", resumen: "Conceptos avanzados en teor√≠a de la computaci√≥n y algoritmos.", creditos: 96 }
      ],
      "5to A√±o": [
        { id: "01341", nombre: "Formulaci√≥n y Evaluaci√≥n de Proyectos", resumen: "T√©cnicas para la formulaci√≥n, an√°lisis y evaluaci√≥n de proyectos de inversi√≥n en TI.", creditos: 96 },
        { id: "01504", nombre: "Lenguajes y Compiladores", resumen: "Estudio de los lenguajes de programaci√≥n y el dise√±o de compiladores.", creditos: 80 },
        { id: "01494", nombre: "Introducci√≥n a la Inteligencia Computacional", resumen: "Fundamentos de inteligencia artificial, aprendizaje autom√°tico y sus aplicaciones.", creditos: 80 },
        { id: "01505", nombre: "Ciencia de Datos", resumen: "Introducci√≥n a la ciencia de datos, an√°lisis de grandes vol√∫menes de informaci√≥n y t√©cnicas de modelado.", creditos: 80 }
      ],
      "Trabajo Final": [
        { id: "01506", nombre: "Trabajo Final", resumen: "Desarrollo de un proyecto integrador que aplica los conocimientos adquiridos durante la carrera.", creditos: 200 }
      ]
    };

    // Flatten the subjects into a single object for easy lookup by ID
    const materiasPlan = {};
    Object.values(materias).flat().forEach(m => {
      if (m.tipo === "Optativa" && m.opciones) {
        m.opciones.forEach(opt => materiasPlan[opt.id] = opt);
      } else {
        materiasPlan[m.id] = m;
      }
    });

    // --- Curriculum Grid Rendering ---
    // Renders the entire curriculum grid, updates progress, and handles subject card clicks
    function renderMalla() {
      const container = document.getElementById("malla");
      container.innerHTML = ""; // Clear existing grid
      const aprobadas = JSON.parse(localStorage.getItem("materiasAprobadas") || "[]");

      // --- Equivalencias autom√°ticas ---
      const equivalencias = ["01474", "01475", "01374", "01476", "01325"];

      const aprobadasConEquivalencias = [...new Set([...aprobadas, ...equivalencias])];
      let total = 0, completas = 0;

      for (const [anio, materiasAnio] of Object.entries(materias)) {
        const div = document.createElement("div");
        div.className = "bg-white dark:bg-gray-800 rounded shadow p-4 border border-gray-200 dark:border-gray-700";
        div.innerHTML = `<h2 class='text-lg font-semibold text-blue-700 dark:text-blue-300 mb-3 px-2 py-1 bg-blue-50 dark:bg-blue-900/30 rounded-md'>${anio}</h2>`;

        materiasAnio.forEach(m => {
          if (m.tipo === "Optativa" && m.opciones) {
            // Handle optative subjects as a group
            const optativaCard = document.createElement("div");
            optativaCard.className = `p-4 mb-3 rounded-lg border border-gray-200 dark:border-gray-700 text-sm transition-all duration-200 
              bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200`;
            optativaCard.innerHTML = `
              <div class="font-semibold mb-2">${m.nombre}</div>
              <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">${m.resumen}</p>
              <ul class="list-disc list-inside text-xs text-gray-700 dark:text-gray-300">
                ${m.opciones.map(opt => {
                  const aprobado = aprobadas.includes(opt.id);
                  if (aprobado) completas++; // Count optativas as completed if any is approved
                  total++; // Count each optativa option as a potential subject
                  return `<li class="${aprobado ? 'line-through text-green-700 dark:text-green-300' : ''}">${opt.nombre} (${opt.creditos} cr√©ditos)</li>`;
                }).join('')}
              </ul>
            `;
            div.appendChild(optativaCard);
          } else {
            const aprobado = aprobadasConEquivalencias.includes(m.id);
            const card = document.createElement("div");
            card.className = `p-4 mb-3 rounded-lg border border-gray-200 dark:border-gray-700 text-sm cursor-pointer transition-all duration-200 ${aprobado ? 
              'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 line-through' : 
              'hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-800 dark:text-gray-200'}`;
            card.innerHTML = `
              <div class="flex items-center justify-between">
                <span class="${aprobado ? 'opacity-70' : ''}">${m.nombre}</span>
                ${m.creditos ? `<span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full text-gray-600 dark:text-gray-300">${m.creditos} cr√©ditos</span>` : ''}
              </div>
            `;
            card.onclick = () => {
              materiaActual = m.id; // Set the current subject ID
              document.getElementById("modalTitulo").textContent = m.nombre;
              document.getElementById("modalResumen").textContent = m.resumen || "(Sin resumen disponible)";
              const notas = JSON.parse(localStorage.getItem("notasPersonales") || "{}");
              document.getElementById("notaPersonal").value = notas[m.id] || "";
              
              // Update the "Mark as Approved" button text and style
              const btnAprobar = document.getElementById("btnAprobar");
              if (aprobadasConEquivalencias.includes(m.id)) {
                btnAprobar.textContent = "Desmarcar como Aprobada";
                btnAprobar.classList.remove("bg-green-600", "hover:bg-green-500");
                btnAprobar.classList.add("bg-yellow-600", "hover:bg-yellow-500");
              } else {
                btnAprobar.textContent = "Marcar como Aprobada";
                btnAprobar.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
                btnAprobar.classList.add("bg-green-600", "hover:bg-green-500");
              }

              renderArchivosCargados(); // Load and display files associated with the subject
              abrirModal(); // Show the subject details modal
            };
            div.appendChild(card);
            total++; // Increment total subjects count
            if (aprobado) completas++; // Increment approved subjects count
          }
        });

        container.appendChild(div);
      }
      // Update progress text
      document.getElementById("progresoTexto").textContent = `Progreso: ${total > 0 ? Math.round((completas / total) * 100) : 0}% completado`;
    }

    // --- Reset Functionality (with Custom Confirmation Modal) ---
    // Show the custom confirmation modal for resetting data
    document.getElementById("resetear").addEventListener("click", () => {
      const confirmModal = document.getElementById("confirmModal");
      const confirmModalContent = document.getElementById("confirmModalContent");
      confirmModal.classList.remove("hidden");
      // Trigger reflow to ensure transition plays
      void confirmModalContent.offsetWidth;
      confirmModalContent.classList.remove("scale-95", "opacity-0");
      confirmModalContent.classList.add("scale-100", "opacity-100");
    });

    // Cancel the reset operation and hide the confirmation modal
    function cancelReset() {
      const confirmModal = document.getElementById("confirmModal");
      const confirmModalContent = document.getElementById("confirmModalContent");
      confirmModalContent.classList.remove("scale-100", "opacity-100");
      confirmModalContent.classList.add("scale-95", "opacity-0");
      confirmModalContent.addEventListener('transitionend', function handler() {
        confirmModal.classList.add("hidden");
        confirmModalContent.removeEventListener('transitionend', handler);
      }, { once: true });
    }

    // Execute the reset operation (clear all localStorage data)
    function executeReset() {
      localStorage.removeItem("materiasAprobadas");
      localStorage.removeItem("notasPersonales");
      localStorage.removeItem("calendarioEntries"); // Clear unified calendar data
      localStorage.removeItem("archivosMaterias"); // Clear uploaded files as well
      localStorage.removeItem("agendaPersonal"); // Clear agenda data
      location.reload(); // Reload the page to reflect changes
    }

    // Initial render calls
    renderMalla();
    requestNotificationPermission(); // Request notification permission on load
    scheduleNotifications(); // Schedule notifications on load

    // --- Nuevas funcionalidades ---

    // Exportar a PDF
    document.getElementById("exportarPdf").addEventListener("click", () => {
      const printContents = document.getElementById("malla").innerHTML;
      const original = document.body.innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = original;
      location.reload();
    });

    // Guardar backup
    document.getElementById("guardarBackup").addEventListener("click", () => {
      const data = {
        materiasAprobadas: localStorage.getItem("materiasAprobadas"),
        notasPersonales: localStorage.getItem("notasPersonales"),
        calendarioEntries: localStorage.getItem("calendarioEntries"), // Use unified key
        archivosMaterias: localStorage.getItem("archivosMaterias"),
        agendaPersonal: localStorage.getItem("agendaPersonal"), // Include agenda
      };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_malla.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Cargar backup
    document.getElementById("cargarBackup").addEventListener("click", () => {
      document.getElementById("inputBackup").click();
    });

    document.getElementById("inputBackup").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const data = JSON.parse(event.target.result);
        localStorage.setItem("materiasAprobadas", data.materiasAprobadas || "[]");
        localStorage.setItem("notasPersonales", data.notasPersonales || "{}");
        localStorage.setItem("calendarioEntries", data.calendarioEntries || "[]"); // Use unified key
        localStorage.setItem("archivosMaterias", data.archivosMaterias || "{}");
        localStorage.setItem("agendaPersonal", data.agendaPersonal || ""); // Load agenda
        location.reload();
      };
      reader.readAsText(file);
    });

    // Exportar a iCal
    document.getElementById("exportIcal").addEventListener("click", () => {
      let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Malla Curricular App//NONSGML v1.0//EN\n`;

      calendario.forEach(item => {
        if (item.type === 'evento') {
          const startDate = new Date(`${item.fechaEvento}T${item.horaEvento || '00:00'}`);
          const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // Assume 1 hour duration if no end time

          const formatDateTime = (date) => {
            return date.toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0, 15) + 'Z';
          };

          icsContent += `BEGIN:VEVENT\n`;
          icsContent += `UID:${Date.now()}-${Math.random().toString(36).substring(2, 9)}\n`;
          icsContent += `DTSTAMP:${formatDateTime(new Date())}\n`;
          icsContent += `DTSTART:${formatDateTime(startDate)}\n`;
          icsContent += `DTEND:${formatDateTime(endDate)}\n`;
          icsContent += `SUMMARY:${item.tipoEvento}: ${item.nombreEvento}\n`;
          if (item.descripcionEvento) {
            icsContent += `DESCRIPTION:${item.descripcionEvento}\n`;
          }
          icsContent += `END:VEVENT\n`;
        } else if (item.type === 'clase') {
          // For classes, which are recurring, iCal is more complex (RRULE).
          // For simplicity, we'll just add a single event for today/next occurrence.
          // A full recurring event implementation is more involved.
          const daysOfWeek = { "Lunes": 1, "Martes": 2, "Mi√©rcoles": 3, "Jueves": 4, "Viernes": 5, "S√°bado": 6, "Domingo": 0 };
          const today = new Date();
          let nextOccurrence = new Date(today);
          nextOccurrence.setDate(today.getDate() + (daysOfWeek[item.dia] + 7 - today.getDay()) % 7);
          
          const [startHour, startMinute] = item.hora.split(' ')[0].split(':').map(Number);
          nextOccurrence.setHours(startHour, startMinute, 0, 0);

          const classDuration = 2; // Assume 2 hours for classes
          const classEnd = new Date(nextOccurrence.getTime() + classDuration * 60 * 60 * 1000);

          const formatDateTime = (date) => {
            return date.toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0, 15) + 'Z';
          };

          icsContent += `BEGIN:VEVENT\n`;
          icsContent += `UID:${Date.now()}-${Math.random().toString(36).substring(2, 9)}-clase\n`;
          icsContent += `DTSTAMP:${formatDateTime(new Date())}\n`;
          icsContent += `DTSTART:${formatDateTime(nextOccurrence)}\n`;
          icsContent += `DTEND:${formatDateTime(classEnd)}\n`;
          icsContent += `SUMMARY:Clase: ${item.materia} (${item.comision || 'Sin comisi√≥n'})\n`;
          icsContent += `DESCRIPTION:Horario regular de clase.\n`;
          // For recurring classes, a more robust solution would use RRULE:
          // icsContent += `RRULE:FREQ=WEEKLY;BYDAY=${item.dia.substring(0,2).toUpperCase()}\n`;
          icsContent += `END:VEVENT\n`;
        }
      });

      icsContent += `END:VCALENDAR`;

      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'calendario_malla.ics';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // --- Gemini API Integration ---

    // Function to call Gemini API
    async function callGeminiAPI(prompt, targetElementId, title) {
        const geminiResponseContent = document.getElementById('geminiResponseContent');
        const geminiLoading = document.getElementById('geminiLoading');
        const geminiError = document.getElementById('geminiError');
        const geminiResponseTitle = document.getElementById('geminiResponseTitle');

        geminiResponseTitle.textContent = title;
        geminiResponseContent.innerHTML = ''; // Clear previous content
        geminiLoading.classList.remove('hidden');
        geminiError.classList.add('hidden');
        openModal('modalGeminiResponse');

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = ""; // Canvas will provide this at runtime

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                geminiResponseContent.innerHTML = `<p>${text}</p>`;
            } else {
                geminiError.classList.remove('hidden');
                geminiResponseContent.innerHTML = '';
                console.error('Unexpected Gemini API response structure:', result);
            }
        } catch (error) {
            geminiError.classList.remove('hidden');
            geminiResponseContent.innerHTML = '';
            console.error('Error calling Gemini API:', error);
        } finally {
            geminiLoading.classList.add('hidden');
        }
    }

    // Event listener for "Obtener M√°s Informaci√≥n" button in subject modal
    document.getElementById("getGeminiMateriaInfo").addEventListener("click", () => {
        const materia = materiasPlan[materiaActual];
        if (materia) {
            const prompt = `Dame m√°s informaci√≥n detallada, conceptos clave y posibles recursos adicionales (libros, cursos online, temas de investigaci√≥n) sobre la materia "${materia.nombre}" que tiene el siguiente resumen: "${materia.resumen}". Enf√≥cate en la relevancia de la materia para la carrera de sistemas.`;
            callGeminiAPI(prompt, 'geminiResponseContent', `Informaci√≥n de ${materia.nombre}`);
        }
    });

    // Event listener for "Expandir Elemento" button in agenda modal
    document.getElementById("expandAgendaBtn").addEventListener("click", () => {
        const agendaText = document.getElementById("agendaPersonalTextarea").value;
        if (agendaText.trim() !== "") {
            const prompt = `Expande el siguiente elemento de agenda o sugiere sub-tareas, ideas relacionadas, o una posible planificaci√≥n para ello. Si es una tarea, desgl√≥sala en pasos. Si es una idea, genera conceptos afines: "${agendaText}"`;
            callGeminiAPI(prompt, 'geminiResponseContent', 'Expansi√≥n de Agenda');
        } else {
            alert("Por favor, escribe algo en la agenda personal para expandir.");
        }
    });

  </script>
</body>
</html>
